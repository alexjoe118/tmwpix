<!DOCTYPE html>
<html lang="zxx">

<head>
    <title>TMWPIX</title>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <meta content="TMWPIX" name="description" />
    <meta content="" name="keywords" />
    <meta content="" name="author" />
    <!-- CSS Files
    ================================================== -->
    <link id="bootstrap" href="css/bootstrap.min.css" rel="stylesheet" type="text/css" />
    <link href="css/style.css" rel="stylesheet" type="text/css" />
    <link id="font" href="fonts/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css" />
</head>

<body>
    <div id="film-container" class="px-1 pb-5">
        <!-- header begin -->
        <header class="">
            <div class="p-3 d-flex align-items-center justify-content-between">
                <div class="back_btn_container d-flex justify-content-start">
                    <a href="#" onclick="window.history.back()" class="back_btn"><i
                            class="fa fa-3x fa-angle-left"></i></a>
                </div>

                <a href="#">
                    <img src="./img/logotmwpix.png" width="200" height="50" class="logo-img">
                </a>

            </div>
        </header>
        <!-- header close -->
        <!-- content begin -->
        <div class="film-content mt-2 px-1">
            <div class="d-flex flex-column justify-content-center">
                <div class="film-header d-flex align-items-center justify-content-center mt-1">
                    <img src="./img/0.png" class="film_classification_img">
                    <div class="film_classification_name">
                        A Família Mitchell e a Revolta das Máquinas
                    </div>
                </div>
            </div>
            <div class="d-flex justify-content-center">
                <div class="film-content-container d-flex justify-content-between">
                    <img id="capcha_image" src="./img/noposter.png" />
                    <div class="film_desc_content">
                        <div class="description_title">
                            Descrição
                        </div>
                        <div class="description_content">
                            Um pai antiquado e sua filha, uma cineasta experiente em tecnologia, viajam para uma nova
                            faculdade enquanto tentam se adaptar. A jornada é interrompida por um apocalipse que ameaça
                            separar esses heróis se eles não se unirem e encontrarem uma maneira de salvar a humanidade.
                        </div>
                        <div class="play_button_container">
                            <button class="play_button" data-bs-toggle="modal" data-bs-target="#rental_details">
                                Conferir alugue</button>
                        </div>
                    </div>
                    <div class="film_report_content d-flex flex-column">
                        <div class="ticket_btn_group">
                            <button class="report_button ticket">Reportar Erro</button>
                            <button class="report_button resolved" data-bs-toggle="modal"
                                data-bs-target="#error_resolved">Resolvido</button>
                        </div>
                        <div class="film_detail_info_label">
                            Ano:
                        </div>
                        <div id="release_year" class="film_detail_info">
                            2021
                        </div>
                        <div class="film_detail_info_label">
                            Duração:
                        </div>
                        <div id="duration" class="film_detail_info">
                            1 hora e 53 minutos
                        </div>
                        <div class="aluguel_status">
                            <div class="film_detail_info_label mt-2">
                                Preço de aluguel:
                            </div>
                            <div id="rental_price" class="film_detail_info" style="color:#00b200;">
                                R$ 11.11
                            </div>
                            <div class="film_detail_info_label">
                                Duração:
                            </div>
                            <div class="film_detail_info">
                                48h
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal fade" id="error_resolved" tabindex="-1" aria-labelledby="Search films" aria-hidden="true">
            <div class="modal-dialog custom_modal">
                <div class="modal-content">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="text-white modalTitle">Erro Resolvido</div>
                        <div class="close_modal" data-bs-dismiss="modal" aria-label="Close">X Fechar</div>
                    </div>

                    <div class="error_resolved_container p-2">
                        <input class="text-center" id="error_resolved_input" placeholder="" />
                    </div>

                    <div class="error_resolved_btn_container d-flex justify-content-center">
                        <button class="error_resolved_btn" data-bs-dismiss="modal" aria-label="Close">OK</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal fade" id="reportar_erro" tabindex="-1" aria-labelledby="Search films" aria-hidden="true">
            <div class="modal-dialog custom_modal">
                <div class="modal-content">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="text-white modalTitle">Reportar Erro</div>
                        <div class="close_modal" data-bs-dismiss="modal" aria-label="Close">X Fechar</div>
                    </div>

                    <div class="error_resolved_container p-2">
                        <textarea class="text-center" id="reportar_erro_input" placeholder=""></textarea>
                    </div>

                    <div class="error_resolved_btn_container d-flex justify-content-center">
                        <button class="error_resolved_btn" onclick="sendTicket()">Enviar</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal fade" id="rental_details" tabindex="-1" aria-labelledby="Search films" aria-hidden="true">
            <div class="modal-dialog custom_modal">
                <div class="modal-content">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="text-white">detalhes da locação </div>
                        <div class="close_modal" data-bs-dismiss="modal" aria-label="Close">X Fechar</div>
                    </div>

                    <div class="rental_details_container text-center text-white fw-bold p-2">
                        <div>ALUGUE ESTE FILME</div>
                        <div class="text-decoration-underline" id="rental_details_film_name">A Família Mitchell e a
                            Rebelião das Máquinas</div>
                        <div>ALUGUE E ASSISTA AGORA MESMO POR&nbsp;<span style="color: #00b200;">R$&nbsp;<span
                                    class="rental_details_pre_rent">14,90</span></span></div>
                        <div>O FILME ESTARÁ DISPONÍVEL POR 48 HORAS</div>
                    </div>

                    <div class="text-white text-start">
                        <div>Termos:</div>
                        Ao continuar, você cliente TMWPIX concorda que o valor R$&nbsp;
                        <span class="rental_details_pre_rent">14,90</span> será
                        adicionado na sua próxima cobrança ou fatura a pagar. Após
                        confirmação do aluguel, o filme estará disponível por 48
                        horas exatamente. Não haverá reembolso do valor ou extensão
                        do tempo de disponibilidade em situação alguma.
                    </div>

                    <div class="d-flex justify-content-between modal_footer_container">
                        <div class="rental_details_cancel" data-bs-dismiss="modal">CANCELAR</div>
                        <div class="rental_details_hire" data-bs-dismiss="modal" onclick="onToHire()">ALUGAR</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Javascript Files
    ================================================== -->
    <script src="js/plugins.js"></script>

    <script>
        const queryString = window.location.search;
        const urlParams = new URLSearchParams(queryString);
        const userToken = JSON.parse(window.localStorage.getItem('LOGGED_USR'));
        if (userToken == null) {
            window.location.href = "./login.html";
        }
        const movieId = urlParams.get('movieId');
        var profileId = -1;
        var ticket = {};
        var activeModalItem = 0;
        var movieData = {};
        const link = `http://api.tmwpix.com/user/info?user=${userToken.usr}&time=${userToken.time}&hash=${userToken.hash}&dtoken=${userToken.pass}&os=android&operator=1&tipo=${userToken.loginType}&usrtoken=${userToken.usrtoken}&hashtoken=${userToken.hashtoken}`;
        $.ajax({
            url: link,
            type: 'GET',
            dataType: 'json',
            success: function (result) {
                if (result.hasOwnProperty('error')) {
                    alert(result['error']['message']);
                    window.location.href = "./login.html";
                } else {
                    userToken.usrinfo = result[0];
                    openTicket();


                    console.log(userToken);
                    profileId = userToken.profile.id;

                    const link2 = `http://api.tmwpix.com/movieinfofull?appversion=1.3&id=${movieId}&perfis=${profileId}&user=&time=1657435701486&hash=3f9b7d853e407cc1159077ad82b0fb1d&dtoken=d41d8cd98f00b204e9800998ecf8427e&os=android&operator=1&tipo=t&usrtoken=APP123&hashtoken=aa2dd11aad8d9664a4cd9ac33b49caa9`;
                    $.ajax({
                        url: link2,
                        type: 'GET',
                        dataType: 'json',
                        success: function (result) {
                            if (result.hasOwnProperty('error')) {
                                alert(result['error']['message']);
                            } else {
                                movieData = result;
                                window.localStorage.setItem('g_movieData', JSON.stringify(movieData));


                                console.log(movieData);
                                $("#capcha_image").attr("src", result['movies'][0].image);
                                $(".film_classification_name").html(result['movies'][0].name);
                                $("#rental_details_film_name").html(result['movies'][0].name);

                                $(".description_content").html(result['movies'][0].description);
                                $("#release_year").html(result['movies'][0].year);
                                $("#duration").html((result['movies'][0].duration / 60 >= 1
                                    ? `${Math.floor(result['movies'][0].duration / 60)} hora${result['movies'][0].duration / 60 >= 2 ? 's' : ''
                                    }`
                                    : '') +
                                    (result['movies'][0].duration -
                                        Math.floor(result['movies'][0].duration / 60) >
                                        0 && result['movies'][0].duration / 60 >= 1
                                        ? ' e '
                                        : '') +
                                    (result['movies'][0].duration -
                                        Math.floor(result['movies'][0].duration / 60) >
                                        0
                                        ? `${result['movies'][0].duration -
                                        Math.floor(result['movies'][0].duration / 60) * 60
                                        } minuto${result['movies'][0].duration -
                                            Math.floor(result['movies'][0].duration / 60) * 60 >
                                            1
                                            ? 's'
                                            : ''
                                        }`
                                        : ''));
                                var aluguel_html = "";
                                if (result['movies'][0].aluguel > 0 &&
                                    userToken.usrinfo.AluguelGratis === 0 &&
                                    (result['movies'][0].alugado === 0 || result['movies'][0].restoaluguel === '')) {
                                    aluguel_html += '<div class="film_detail_info_label mt-2">Preço de aluguel:</div>';
                                    if (userToken.usrinfo.AluguelGratisRestante > 0 && result['movies'][0].aluguel === 1) {
                                        aluguel_html += `<div id="rental_price" class="film_detail_info" style="color:#00b200;">Grátis (${userToken.usrinfo.AluguelGratisRestante}/${userToken.usrinfo.PlanoAluguelGratis} por mês)</div>`;
                                    } else {
                                        aluguel_html += `<div id="rental_price" class="film_detail_info" style="color:#00b200;">R$${' '}${result['movies'][0].precoaluguel.toString().replace('.', ',')}</div>`;
                                    }

                                    aluguel_html += '<div class="film_detail_info_label">Duração:</div><div class="film_detail_info">48h</div>';
                                }
                                if (result['movies'][0].aluguel > 0 &&
                                    userToken.usrinfo.AluguelGratis === 0 &&
                                    result['movies'][0].alugado !== 0 &&
                                    result['movies'][0].restoaluguel !== '') {
                                    aluguel_html += '<div class="film_detail_info_label"><div style="color: orange;" >Filme alugado</div>até:</div>';
                                    aluguel_html += `<div style={ color: orange; }>${result['movies'][0].finalaluguel}</div><div class="film_detail_info_label" style="font-weight: normal;">até:</div>`;
                                }

                                $(".aluguel_status").html(aluguel_html);
                                aluguel_html = "";
                                if (result['movies'][0].aluguel > 0 &&
                                    userToken.usrinfo.AluguelGratis === 0 &&
                                    result['movies'][0].alugado === 0) {

                                } else {
                                    onToHire();
                                }
                                $(".rental_details_pre_rent").html(` ${result['movies'][0].precoaluguel.toString().replace('.', ',')}`);


                                src = "./img/0.png"
                                $(".film_classification_img").attr("src", "./img/" + result['movies'][0].classificacao + ".png");


                                console.log(result);
                            }
                        },
                        error: function (xhr, status, error) {
                            alert(`Error ${error}`);
                        },

                    });

                }
            },
            error: function (xhr, status, error) {
                alert(`Error ${error}`);
            },

        });

        function openTicket() {
            const link3 = `http://api.tmwpix.com/ticket?idconteudo=${movieId}&cliente_id=${userToken.usrinfo.idCliente}&tipoconteudo=filmes&perfis=${userToken.profile.id}&user=${userToken.usr}&time=${userToken.time}&hash=${userToken.hash}&dtoken=${userToken.pass}&os=android&operator=1&tipo=${userToken.loginType}&usrtoken=${userToken.usrtoken}&hashtoken=${userToken.hashtoken}`;
            $.ajax({
                url: link3,
                type: 'GET',
                dataType: 'json',
                success: function (result) {
                    if (result.hasOwnProperty('error')) {
                        alert(result['error']['message']);
                    } else {
                        console.log("ticket", result);
                        ticket = JSON.parse(result);
                        if (ticket.erro === undefined) {
                            ticket = ticket.ticket;
                        } else {
                            ticket = { status: '', resposta: ticket.erro };
                        }
                        var btn_group = "";
                        console.log(ticket);
                        if (ticket.status === '') {
                            btn_group += "<button class='report_button ticket' data-bs-toggle='modal'"
                                + "     data-bs-target='#reportar_erro' onclick=''>Reportar Erro</button>";
                        }
                        if (ticket.status === 'aberto') {
                            btn_group += "<button class='report_button ticket'>Erro Aberto</button>";
                        }
                        if (ticket.status === 'analisando') {
                            btn_group += "<button class='report_button ticket'>Erro em Análise</button>";
                        } else {
                            btn_group += "<button class='report_button resolved' data-bs-toggle='modal'"
                                + "     data-bs-target='#error_resolved'>Resolvido</button>";
                        }
                        $(".ticket_btn_group").html(btn_group);
                        $('#error_resolved_input').val(ticket.resposta);

                    }
                },
                error: function (xhr, status, error) {
                    alert(`Error ${error}`);
                },

            });
        }


        function sendTicket() {

            const valueTicket = $('#reportar_erro_input').val();
            var send_link = `http://api.tmwpix.com/sendticket?descricao=${valueTicket}&setor=filmes&idconteudo=${movieData['movies'][0].id}&clientes_id=${userToken.usrinfo.idCliente}&perfis_id=${userToken.profile.id}&user=${userToken.usr}&time=${userToken.time}&hash=${userToken.hash}&dtoken=${userToken.pass}&os=android&operator=1&tipo=${userToken.loginType}&usrtoken=${userToken.usrtoken}&hashtoken=${userToken.hashtoken}&page=movie`;

            $.ajax({
                url: send_link,
                method: 'GET',
                dataType: 'json',
                success: function (result) {
                    if (result.error) {
                        if (parseInt(result.error.code, 10) === 6) {
                            alert(result.error.message);
                            window.localStorage.removeItem('LOGGED_USR');
                            window.location.href = "./login.html";
                        } else {
                            openTicket();
                        }
                    }

                },
                error: function (xhr, status, error) {
                    alert(`Error ${error}`);
                },
            });
        }

        function onToHire() {
            $(".play_button").html("Assistir");
            $(".play_button").click(function () {
                window.location.href = "./play.html";
            });
        }
    </script>
</body>

</html>